# Python 병렬처리 고민. Multi Process? Multi Thread?

고성능 파이썬 백엔드 작업을 위해서는 병렬처리에대한 고민을 한번 쯤 해볼 수 있습니다. 일반적으로 코드 구현에만 집중하여 성능향상에 고민을 해보지 않은 개발자의 경우 병렬처리의 필요성을 경험해보지 못하거나, Process와 Thread의 개념을 이해하지 못하고 있는 경우도 종종 있습니다. 특히 파이썬의 경우 다른 언어에비해 배우기 쉽고 편의성이 좋지만, 실행 속도 측면에서 느리다는 치명적인 단점이 있기 때문에, Thread와 Process에 대한 이해를 바탕으로 Multi Process, Multi Thread 적용에대해 알고있는 것이 중요합니다.

<br>

## #1. Process? Thread? 🤦🏻‍♂️
일반적으로 CS공부를 하면 프로세스와 쓰레드를 아래처럼 암기하는 경우가 많습니다.
- Process : 컴퓨터에서 실행되고 있는 프로그램을 말하며, 운영체제에 의해 할당된 작업
- Thread : 프로세스 내의 작업의 흐름

위와 같이 암기했을 때 혼돈하기 쉽고 구체적으로 어떤 역할하는지 헷갈릴 수 있습니다. 각각의 역할의 이해하기 위해서는 우선 CPU가 멀티태스킹을 어떻게하는지 부터 확인할 필요가 있습니다. 일반적으로 우리는 컴퓨터를 할 때 파일을 다운로드 받고, 카카오톡도하며 한 번에 여러가지 일을 하며 이는 우리 눈에 보이지는 않는 여러 작업까지 포함하면 수백 개가 넘어갈 수 있습니다. 하지만 일반적으로 컴퓨터의 머리를 담당하는 CPU는 코어 당 한 번에 하나의 프로세스 즉, 하나의 일만 처리할 수 있습니다. 어떻게 수 백개의 일을 거의 한 번에 보이는 것처럼 처리되는지 이해하기 위해서는 병렬 처리와 병행 처리 두가지 이해가 필요합니다.
- 병렬 처리 : 여러 작업을 동시에 실행하는 방법. 2개 이상의 코어가 각기 다른 프로세스의 명령을 실행해서 각 프로세스가 같은 순간에 실행되도록하는 방법
- 병행 처리 : 하나의 코어가 여러 프로세스를 조금씩 처리하는 것을 의미

즉, 컴퓨터의 코어는 각각 하나의 프로세스를 처리하여 2개의 코어를 가진 컴퓨터의 경우 한 번에 2가지 일을 병렬처리합니다. 그리고 해당 코어는 하나의 프로세스를 처리가 다 끝날 때까지 기다리는 것이 아닌 여러 프로세스를 돌아다니면서 조금씩 병행 처리를 합니다. 여기서 하나의 코어가 여러 프로세스를 병행처리하는 것을 컨택스트 스위칭이라 하며, 여러 코어가 여러개의 프로세스를 함께 진행하는 것을 멀티프로세싱이라 부릅니다.

프로세스의 병행 처리, 병렬 처리로 동시에 여러가지 일을 할 수 있지만, 아직 수백 개의 일을 처리하기에는 부족합니다. 이를 위해 프로세스를 또 나눈 단위인 스레드가 있습니다. 스레드는 한 프로세스 안에 하나 이상 진행될 수 있는 일의 단위이며 햄버거 요리를 하나의 프로세스로 생각하면 빵을 데우고, 고기를 굽고, 야채를 써는 과정이 스레드에 의해 프로세스와 같이 컨택스트 스위칭되어 처리됩니다. 즉 스레드가 여러 스레드와 함께 병행 병렬 처리되는 것이 멀티 스레딩이라 합니다.

사실 스레드는 프로세스를 단순히 나눈 단위가 아닌 중요한 차이가 있는데 그것은 바로 "메인 메모리를 어떻게 함께 사용하는지"입니다. 멀티 프로세싱에서 각각의 프로세스는 각각 독립된 메모리 공간을 사용하며, 한번에 실행되는 프로세스가 많다는 의미는 그 만큼 많은 메인 메모리를 사용한다는 것을 의미합니다. 반면 스레드는 동일한 프로세스 내에 모든 스레드가 메모리를 공유하게 됩니다. 즉 아무리 스레드가 많아져도 메모리를 차지 않고 프로세스와 달리 메모리를 옮겨 다닐 필요가 없기 때문에 컨택스트 스위칭의 부담이 덜하는 장점이 있습니다. 이렇게 보았을 때 성능 상 스레드가 유리하지만 같은 메모리 공간을 여러 스레드가 공유해서 사용하는 만큼 발생하는 오류에 대해  추가적인 프로그래밍이 필요하다는 문제점이 있습니다.

### #참고. Process 구조
프로세스는 동적 영역인 Stack, Heap과 정적 영역인 데이터 영역(Bss segment, Data segment), 코드 영역(Code segment)로 구분됩니다. 동적 영역인 스탭은 위에서부터 메모리가 할당되며, 힙은 아래에서 부터 사용되지 않는 메모리에 할당됩니다.

<p align="center"><img src="https://github.com/C-auto/share-docs/assets/91866763/f6d760a6-cde1-4840-9c86-a9fa8e5bc033" width="600"></p>

- 스택 : 지역변수, 매개변수, 함수가 저장되며 컴파일 시에 크기가 결정.
- 힙 : 코드에서 동적으로 생성된 데이터가 저장되며, 동적 할당할 때 사용되며 런타임 시 크기가 결정.
- 데이터 영역 : 전역변수, 정적변수가 저장되며 정적인 특징을 가진 프로그램이 종료되면 사라지는 변수가 들어 있는 영역
  - 데이터 영역 중 BSS는 초기화 되지 않는 변수가 0으로 초기화되어 저장되며, Data 영역은 0이 아닌 다른 값으로 할당된 변수들이 저장
- 코드 영역 : 프로그램에 내장되어 있는 소스 코드가 들어가는 영역. 이 영역은 수정 불가능한 기계어로 저장되어 있으며 정적인 특징을 가짐. 

